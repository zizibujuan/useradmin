<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>完善用户信息</title>
<link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<script src="/jquery/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="/jquery/jquery.json.min.js"></script>
<script src="/bootstrap/js/bootstrap.min.js"></script>
 <script type="text/javascript">
 $(document).ready(function(){
	 var txtLoginName = $("#txtLoginName");
	 var txtNickName = $("#txtNickName");
	 var txtEmail = $("#txtEmail");
	 var btnSave = $("#btnSave");
	 // 从session中加载qq用户名
	 $.getJSON("/users/", function(data){
		 txtNickName.val(data.nickName);
	 });

	 txtLoginName.on("input", function(e){
		validateForm();
	 });
	 
	 txtNickName.on("input", function(e){
		validateForm();
	 });
	 txtEmail.on("input", function(e){
		validateForm();
	 });
	 
	 btnSave.on("click", function(e){
		 var data = getFormData();
		 $.post("completeUserInfo", $.toJSON(data)).done(function(data){
			 // 跳到目标页面，目前就这一个目标页面，所以硬编码
			 window.location.href = "/files/new";
		 }).fail(function(){
			 
		 });
	 });
	
	
	function validateForm(){
		// TODO: 校验用户名，邮箱是否被使用
		var userInfo = getFormData();
		var result = validate(userInfo);
		if(result){
			btnSave.attr("disabled", false);
		}else{
			btnSave.attr("disabled", true);
		}
	}
	
	function getFormData(){
		var loginName = txtLoginName.val().trim();
		var nickName = txtNickName.val().trim();
		var email = txtEmail.val().trim();
		return {
			"loginName": loginName,
			"nickName": nickName,
			"email": email
		};
	}
	
	function validate(userInfo){
		// TODO：显示校验不通过时的提示信息
		return userInfo.loginName != "" &&
			userInfo.nickName != "" &&
			userInfo.email != "" &&
			checkEmail(userInfo.email);
	}
	
	function checkEmail(email){
		var emailRegExp = /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i;
		return emailRegExp.test(email);
	}
 });
 </script>
</head>
<body>
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">完善用户信息</h3>
  </div>
  <div class="panel-body">
    <form role="form">
      <div class="form-group">
	    <label for="txtLoginName">用户名(必填, 只能使用英文字母，数字与下划线)</label>
	    <input type="text" required class="form-control" id="txtLoginName">
	  </div>
	  <div class="form-group">
	    <label for="txtNickName">昵称(必填)</label>
	    <input type="text" required class="form-control" id="txtNickName">
	  </div>
	  <div class="form-group">
	    <label for="txtEmail">邮箱(必填)</label>
    	<input type="email" required class="form-control" id="txtEmail" placeholder="请输入常用邮箱">
	  </div>
	  <button type="button" id="btnSave" class="btn btn-primary" disabled="disabled">完成</button>
	</form>
  </div>
</div>
</body>
</html>